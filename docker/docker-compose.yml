version: "3.9"

services:
  openclaw-sandbox:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: openclaw-sandbox

    # Non-root user (sandbox uid:gid = 1000:1000)
    user: "1000:1000"

    ports:
      # Bind to localhost (127.0.0.1) ONLY for security
      # This prevents access from other devices on the LAN or Internet
      - "127.0.0.1:8080:8080"   # noVNC web UI
      - "127.0.0.1:18789:18789" # OpenClaw API
      - "127.0.0.1:18790:18790" # OpenClaw WebSocket/Gateway
      - "127.0.0.1:3000:3000"   # AIClient-2-API UI/API

    environment:
      - TZ=Etc/UTC
      - HOME=/home/sandbox
      - OPENCLAW_HOME=/home/sandbox/.openclaw
      # Point Playwright to the installed system Chromium
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium-browser
      # Critical for running Chromium in a container without SYS_ADMIN cap
      - PLAYWRIGHT_LAUNCH_OPTIONS={"args":["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]}

    volumes:
      # Persistent workspace for projects (Host Bind Mount)
      - ./data:/home/sandbox/.openclaw/workspace:rw
      
      # Persistence for OpenClaw Skills/Plugins (Named Volume)
      - openclaw_extensions:/home/sandbox/.openclaw/extensions:rw

      # Persistence for AIClient-2-API configs (Named Volume)
      - aiclient_configs:/opt/aiclient/configs:rw

      # Persistence for browser sessions (WhatsApp, Telegram, Discord logins)
      - ./data/.config:/home/sandbox/.config:rw
      - ./data/.cache:/home/sandbox/.cache:rw
      
      # Persistence for development tools & identity
      - ./data/.gitconfig:/home/sandbox/.gitconfig:rw
      - ./data/.ssh:/home/sandbox/.ssh:rw
      - ./data/.npm:/home/sandbox/.npm:rw

    # Read-only root filesystem prevents unauthorized system changes
    read_only: true

    # Tmpfs for transient runtime files
    tmpfs:
      - /tmp
      - /run
      - /home/sandbox/.local/share  # Chrome crash dumps etc.

    # Increased shared memory prevents browser crashes on heavy sites
    shm_size: 2gb

    # "always" ensures the container starts on host boot, even if it was stopped before
    restart: always

    security_opt:
      - no-new-privileges:true

    # Drop all capabilities; reliance on --no-sandbox allows this hardening to stay
    cap_drop:
      - ALL

    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8g

    group_add:
      - "1000"

volumes:
  openclaw_extensions:
  aiclient_configs:
