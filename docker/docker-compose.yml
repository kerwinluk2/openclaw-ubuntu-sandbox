version: "3.9"

services:
  openclaw-sandbox:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: openclaw-sandbox

    # Non-root user (sandbox uid:gid = 1000:1000)
    user: "1000:1000"

    ports:
      - "8080:8080"   # noVNC web UI
      - "18789:18789" # OpenClaw API/WebSocket
      - "18790:18790" # OpenClaw additional port

    environment:
      - TZ=Etc/UTC
      - HOME=/home/sandbox
      - OPENCLAW_HOME=/home/sandbox/.openclaw
      # Chromium path for Playwright
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium-browser

    volumes:
      # Persistent workspace for OpenClaw data and projects
      - ./data:/home/sandbox/.openclaw/workspace:rw
      # Git config persistence
      - ./data/.gitconfig:/home/sandbox/.gitconfig:rw
      # Node/npm cache (optional, speeds up reinstalls)
      - ./data/.npm:/home/sandbox/.npm:rw

    # Read-only root filesystem
    read_only: true

    # Tmpfs for transient data
    tmpfs:
      - /tmp
      - /run
      - /home/sandbox/.cache

    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    # Drop all capabilities; add back only if OpenClaw browser automation requires
    cap_drop:
      - ALL

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8g

    # Group for Chromium sandbox (required for Playwright/Chromium)
    group_add:
      - "1000"
